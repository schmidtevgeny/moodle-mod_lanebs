define("mod_lanebs/modal_video",["exports","jquery","core/ajax","core/modal_factory","core/modal_events","core/notification","core/modal","core/custom_interaction_events","core/modal_registry","mod_lanebs/modal_player_handle","core/str"],(function(exports,$,ajax,ModalFactory,ModalEvents,Notification,Modal,CustomEvents,ModalRegistry,ModalPlayerHandle,Str){let SELECTORS_SUBMIT_BUTTON="[data-action='submit_button']",SELECTORS_OPEN_BUTTON_CONTAINER="#id_modal_video_button",SELECTORS_CANCEL_BUTTON="[data-action='close_button']",SELECTORS_CONTENT_BLOCK="[data-action='video_content_block']",SELECTORS_CLOSE_CROSS=".close",SELECTORS_DATA_TOC="#data-toc",SELECTORS_BOOK_ID_SELECTOR="[name='content']",SELECTORS_SEARCH_CLASS=".modal_video",SELECTORS_VIDEOS_FIELD="input[name='videos']",SELECTORS_DELETE_SELECTED="span.closes",SELECTORS_PREVIEW_CLASS=".video-item",SELECTORS_PREVIEW_CONTAINER=".video_preview_container",SELECTORS_TRIGGER_PLAYER="img.modal_video",SELECTORS_PLAY_BUTTON_HOVER=".video_play_hover",ModalVideo=function(root){Modal.call(this,root),ModalVideo.prototype.modal=this,this.printTocs()};return ModalVideo.TYPE="mod_lanebs-video",ModalVideo.CONTENT_BLOCK=SELECTORS_CONTENT_BLOCK,ModalVideo.prototype=Object.create(Modal.prototype),ModalVideo.prototype.constructor=ModalVideo,ModalVideo.prototype.registerEventListeners=function(){Modal.prototype.registerEventListeners.call(this),this.getModal().on(CustomEvents.events.activate,SELECTORS_SUBMIT_BUTTON,ModalVideo.prototype.updateVideoField),this.getRoot().on(CustomEvents.events.activate,SELECTORS_CANCEL_BUTTON+", "+SELECTORS_CLOSE_CROSS,function(){this.destroy(),this.getBackdrop().then((function(backdrop){backdrop.hide()}))}.bind(this))},ModalVideo.prototype.printTocs=function(){let bookId=$(SELECTORS_BOOK_ID_SELECTOR).val();if(""!==bookId){let tocArgs={id:bookId,page:0};ModalVideo.prototype.getAjaxCall("mod_lanebs_toc_name",tocArgs,(function(tocs){let videosArgs={id:$(SELECTORS_BOOK_ID_SELECTOR).val()};ModalVideo.prototype.getAjaxCall("mod_lanebs_toc_videos",videosArgs,(function(videos){let body=ModalVideo.prototype.modal.getBody(),innerTocHtml="",issetTocVideo=[],BreakException={};tocs&&tocs.forEach((function(value,index){let uniqueIndex,videosList='<ul class="modal_video">',currentPage=value.page;issetTocVideo[index]=!1;try{videos.forEach((function(video,videoIndex){if(video.start_page===currentPage)issetTocVideo[index]=!0,uniqueIndex=video.unique_id+"_"+index,videosList+='<li class="modal_video"><label for="video_'+uniqueIndex+'" class="modal_video"><p class="modal_video"><input type="checkbox" data-unique="'+uniqueIndex+'" class="modal_video" id="video_'+uniqueIndex+'" data-url="'+video.link_url+'" />'+video.link_name+'</p><img src="'+ModalVideo.prototype.getYoutubePreview(video.link_url)+'" alt="'+video.link_name+'" class="modal_video" data-id="'+ModalVideo.prototype.getYoutubeId(video.link_url)+'" /><div class="video_play_hover"></div></label></li>';else if("-1"===video.start_page)throw issetTocVideo[index]=void 0,$(SELECTORS_OPEN_BUTTON_CONTAINER).closest(".form-group").addClass("hidden"),BreakException}))}catch(e){if(e!==BreakException)throw e}videosList+="</ul>",!0===issetTocVideo[index]&&(innerTocHtml+='<div class="item-toc" style="margin-bottom:10px;" data-page="'+currentPage+'"><span>'+value.title+", "+ModalVideo.prototype.strings.lanebs_read_pg+". "+value.page+'</span><br><a class="" data-toggle="collapse" href="#collapseDescription_'+currentPage+"_"+index+'" role="button">Видео-рекомендации</a><div class="collapse" id="collapseDescription_'+currentPage+"_"+index+'">'+videosList+"</div></div>")})),void 0!==issetTocVideo[0]&&($(SELECTORS_OPEN_BUTTON_CONTAINER).closest(".form-group").removeClass("hidden"),body.find(SELECTORS_DATA_TOC).html(innerTocHtml),$(body.find(SELECTORS_TRIGGER_PLAYER)).on("click",(function(e){let linkId=$(e.target).attr("data-id");ModalPlayerHandle.init(e,linkId)})),$(body.find(SELECTORS_PLAY_BUTTON_HOVER)).on("click",(function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).siblings(SELECTORS_TRIGGER_PLAYER).trigger("click")})));let issetVideos=ModalVideo.prototype.getIssetVideos();issetVideos&&(ModalVideo.prototype.printVideos(issetVideos),ModalVideo.prototype.preCheckVideos(issetVideos))}))}))}},ModalVideo.prototype.getAjaxCall=function(methodname,args,callback){return ajax.call([{methodname:methodname,args:args}])[0].then((function(response){return response})).done((function(response){return callback(JSON.parse(response.body)),!0})).fail((function(response){return console.log(response),!1}))},ModalVideo.prototype.printVideos=function(videos){let previewBlock='<div class="col-md-3"></div><div class="container col-md-9">';videos.forEach((function(value,index){previewBlock+='<div class="item video-item row"><div class="img-wraps"><span class="closes" title="Delete" data-unique="'+value.unique+'">×</span><img width="100px;" height="100px;" src="'+ModalVideo.prototype.getYoutubePreview(value.link)+'" alt="'+value.name+'"  class="img-responsive" src="images/image.jpg" data-id="'+ModalVideo.prototype.getYoutubeId(value.link)+'"/></div><span class="video_preview">'+value.name+"</span></div>"})),previewBlock+="</div>",$(SELECTORS_PREVIEW_CONTAINER).html(previewBlock),ModalVideo.prototype.deleteSelectedEvent()},ModalVideo.prototype.getYoutubeId=function(link){let urlParams=link.split("?")[1];return new URLSearchParams(urlParams).get("v")},ModalVideo.prototype.getYoutubePreview=function(link){return"https://img.youtube.com/vi/"+ModalVideo.prototype.getYoutubeId(link)+"/0.jpg"},ModalVideo.prototype.getIssetVideos=function(){let videos=$(SELECTORS_VIDEOS_FIELD).val();try{return JSON.parse(videos)}catch(e){return console.log(e.message),""}},ModalVideo.prototype.preCheckVideos=function(videos){videos.forEach((function(value,index){ModalVideo.prototype.modal.getBody().find('input[data-unique="'+value.unique+'"]').trigger("click")}))},ModalVideo.prototype.deleteSelectedEvent=function(){$(SELECTORS_DELETE_SELECTED).each((function(index,value){$(value).on("click",(function(e){let videoItem=$(e.target).closest(SELECTORS_PREVIEW_CLASS),videoUnique=$(e.target).attr("data-unique");ModalVideo.prototype.modal.getBody().find('input[data-unique="'+videoUnique+'"]').trigger("click"),$(videoItem).remove(),ModalVideo.prototype.updateVideoField()}))}))},ModalVideo.prototype.updateVideoField=function(){let videos=[];ModalVideo.prototype.modal.getBody().find("ul"+SELECTORS_SEARCH_CLASS+" input:checked").each((function(index,value){let url=$(value).attr("data-url");videos.push({link:url,name:$(value).closest("p").text(),unique:$(value).attr("data-unique"),video_id:ModalVideo.prototype.getYoutubeId(url)})})),$(SELECTORS_VIDEOS_FIELD).val(JSON.stringify(videos)),ModalVideo.prototype.printVideos(videos),$(SELECTORS_CANCEL_BUTTON).trigger("click")},ModalVideo.prototype.clearAllData=function(){$(SELECTORS_VIDEOS_FIELD).val("[]"),$(SELECTORS_PREVIEW_CONTAINER).html("")},ModalVideo.prototype.resetModal=function(){ModalVideo.prototype.clearAllData(),ModalVideo.prototype.printTocs()},ModalRegistry.register(ModalVideo.TYPE,ModalVideo,"mod_lanebs/modal_video"),ModalVideo}));

//# sourceMappingURL=modal_video.min.js.map