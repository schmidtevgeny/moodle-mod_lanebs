define("mod_lanebs/modal_search",["exports","core/modal","jquery","core/ajax","core/custom_interaction_events","./modal_book_handle","./modal_video"],(function(_exports,_modal,_jquery,_ajax,_custom_interaction_events,_modal_book_handle,_modal_video){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modal=_interopRequireDefault(_modal),_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events),_modal_video=_interopRequireDefault(_modal_video);class ModalSearch extends _modal.default{configure(modalConfig){modalConfig.removeOnClose=!1,super.configure(modalConfig)}registerEventListeners(){super.registerEventListeners();const modal=this,submitFunction=e=>{_jquery.default.fn.serializeAssoc=function(){var data={};return _jquery.default.each(this.serializeArray(),(function(key,obj){var a=obj.name.match(/(.*?)\[(.*?)\]/);if(null!==a){var subName=a[1],subKey=a[2];data[subName]||(data[subName]=[]),subKey.length||(subKey=data[subName].length),data[subName][subKey]?(_jquery.default.isArray(data[subName][subKey])||(data[subName][subKey]=[]),data[subName][subKey].push(obj.value)):data[subName][subKey]=obj.value}else data[obj.name]?(_jquery.default.isArray(data[obj.name])||(data[obj.name]=[]),data[obj.name].push(obj.value)):data[obj.name]=obj.value})),data},e.preventDefault(),e.stopPropagation();const id=(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).attr("data-id"),args={searchParam:(0,_jquery.default)(e.target.form).serializeAssoc(),page:1,limit:ModalSearch.LIMIT_ON_PAGE,catId:id};(0,_jquery.default)(ModalSearch.SELECTORS.PROGRESS).toggleClass("hide"),ModalSearch.getAjaxCall("mod_lanebs_search_books",args,ModalSearch.getSearchResult).then((function(){ModalSearch.resetPagination(),(0,_jquery.default)(ModalSearch.SELECTORS.PROGRESS).toggleClass("hide")}))};(0,_jquery.default)(ModalSearch.OUTER_SELECTORS.PAGE_NUMBER_FIELD).on("change",ModalSearch.nameFieldFill),this.getModal().on(_custom_interaction_events.default.events.activate,ModalSearch.SELECTORS.START_SEARCH,submitFunction),this.getModal().on("click",ModalSearch.SELECTORS.START_SEARCH_CLEAR,(function(e){return e.preventDefault(),e.stopPropagation(),(0,_jquery.default)(ModalSearch.SELECTORS.SEARCH_TEXTBOX).val(""),(0,_jquery.default)(ModalSearch.SELECTORS.START_SEARCH).trigger("click"),!1})),this.getModal().on("keypress",ModalSearch.SELECTORS.SEARCH_TEXTBOX,(e=>{if(13===e.keyCode)return submitFunction(e),!1})),this.getModal().on(_custom_interaction_events.default.events.activate,ModalSearch.SELECTORS.BOOK_PAGINATION,(e=>{if((0,_jquery.default)(e.currentTarget).hasClass("disabled"))return!0;let page,maxPage;maxPage=void 0===(0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).attr("data-page")?0:parseInt((0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).attr("data-page")),page=(0,_jquery.default)(e.currentTarget).hasClass(ModalSearch.SELECTORS.START_PAGE_CLASS)?maxPage>0?1:0:(0,_jquery.default)(e.currentTarget).hasClass(ModalSearch.SELECTORS.END_PAGE_CLASS)?maxPage:parseInt((0,_jquery.default)(e.currentTarget).attr("data-page"));let id=(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).attr("data-id"),args={searchParam:(0,_jquery.default)(ModalSearch.SELECTORS.SEARCH_FORM).serializeAssoc(),page:page,limit:ModalSearch.LIMIT_ON_PAGE,catId:id},prevPage=(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.prev").closest("li.page-item"),nextPage=(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.next").closest("li.page-item"),currentPage=(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.active").closest("li.page-item");page>=2?((0,_jquery.default)(prevPage).attr("data-page",page-1),(0,_jquery.default)(prevPage).removeClass("disabled")):1===page&&((0,_jquery.default)(prevPage).attr("data-page",page-1),(0,_jquery.default)(prevPage).addClass("disabled")),maxPage===page?(0,_jquery.default)(nextPage).addClass("disabled"):(0,_jquery.default)(nextPage).removeClass("disabled"),(0,_jquery.default)(nextPage).attr("data-page",page+1),(0,_jquery.default)(currentPage).attr("data-page",page),(0,_jquery.default)(currentPage).find("a.active").text(page+" "+ModalSearch.strings.lanebs_from+" "+maxPage),0!==page&&0!==maxPage&&((0,_jquery.default)(ModalSearch.SELECTORS.PROGRESS).toggleClass("hide"),ModalSearch.getAjaxCall("mod_lanebs_search_books",args,ModalSearch.getSearchResult).then((function(){(0,_jquery.default)(ModalSearch.SELECTORS.PROGRESS).toggleClass("hide")})))})),this.getModal().on("keydown",ModalSearch.SELECTORS.CONTENT_NAME,(e=>{if(!1!==e.keyCode)return e.preventDefault(),!1})),this.getModal().on(_custom_interaction_events.default.events.activate,ModalSearch.SELECTORS.CANCEL_BUTTON+", "+ModalSearch.SELECTORS.CLOSE_CROSS,(function(e){e.preventDefault(),e.stopPropagation(),modal.hide()})),this.getModal().on(_custom_interaction_events.default.events.activate,ModalSearch.SELECTORS.CATEGORY_BUTTON,(e=>{e.preventDefault(),e.stopPropagation();let args={categoryId:[null]};ModalSearch.getAjaxCall("mod_lanebs_category_tree",args,ModalSearch.printCategories)}))}static padTo2Digits(num){return num.toString().padStart(2,"0")}static formatDate(date){return[ModalSearch.padTo2Digits(date.getDate()),ModalSearch.padTo2Digits(date.getMonth()+1),date.getFullYear()].join(".")}static getSearchResult(response){(0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).empty();let maxPage=Math.ceil(response.body.total/ModalSearch.LIMIT_ON_PAGE);response.body.items.length?_jquery.default.each(response.body.items,(function(number,item){let descriptionBlock='<a class="" data-toggle="collapse" href="#collapseDescription'+item.id+'" role="button">'+ModalSearch.strings.lanebs_show_desc+'</a><div class="collapse" id="collapseDescription'+item.id+'">'+item.description+"</div>";null!==item.description&&""!==item.description||(item.description="",descriptionBlock=""),(0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).append('<div class="item d-flex" data-id="'+item.id+'"><div class="cover" style="flex:0.2;"><img src="'+item.cover+'" class="book_cover" alt="'+ModalSearch.strings.lanebs_cover+'"></div><div class="item_content" style="flex:0.55;"><span class="book_biblio_record">'+item.biblioRecord.replace(/00.00.0000/,ModalSearch.formatDate(new Date))+'</span><br><span class="book_author hidden">'+item.author+'</span><span class="book_title hidden">'+item.title+"</span>"+descriptionBlock+'</div><div style="flex:0.25;"><button type="button" name="add_book" class="btn btn-sm ml-3" style="color: #174c8d;background-color: white;border-color: #4285f4;">'+ModalSearch.strings.lanebs_add+'</button><button type="button" class="trigger_book btn btn-sm ml-3 float-right" style="color: #174c8d;background-color: white;border-color: #4285f4;" data-page="'+item.page_number+'">'+ModalSearch.strings.lanebs_preshow+'</button><br></div></div><hr style="margin-top:5px;">')})):(0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).append('<div class="item">'+ModalSearch.strings.lanebs_error_empty_search+"</div>"),(0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).attr("data-page",maxPage),(0,_jquery.default)(ModalSearch.SELECTORS.TRIGGER_BOOK).on("click",(function(e){let id=(0,_jquery.default)(e.target).closest(".item").attr("data-id"),pageNumber="toc"===(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_FILTER).val()?(0,_jquery.default)(e.target).attr("data-page"):null;(0,_modal_book_handle.init)(e,id,pageNumber)})),(0,_jquery.default)(ModalSearch.SELECTORS.ADD_BOOK).on("click",(function(e){let id=(0,_jquery.default)(e.target).closest(".item").attr("data-id"),contentName=(0,_jquery.default)('[name="content_name"]'),biblioRecordField=(0,_jquery.default)('[name="biblio_record"]'),coverField=(0,_jquery.default)('[name="cover"]'),resourceNameField=(0,_jquery.default)("#id_name"),bookTitle=(0,_jquery.default)(e.target).closest(".item").find(".item_content .book_title").text(),bookAuthor=(0,_jquery.default)(e.target).closest(".item").find(".item_content .book_author").text(),bookCover=(0,_jquery.default)(e.target).closest(".item").find(".book_cover").attr("src"),bookBiblioRecord=(0,_jquery.default)(e.target).closest(".item").find(".item_content .book_biblio_record").text();resourceNameField.val(bookAuthor+" - "+bookTitle),contentName.removeClass("is-invalid"),contentName.siblings("#id_error_content_name").text(""),contentName.val(bookTitle),(0,_jquery.default)('[name="content"]').val(id),biblioRecordField.val(bookBiblioRecord),coverField.val(bookCover),(0,_jquery.default)(ModalSearch.SELECTORS.CANCEL_BUTTON).trigger("click"),ModalSearch.nameFieldFill(),_modal_video.default.resetModal()}))}}return _exports.default=ModalSearch,_defineProperty(ModalSearch,"TYPE","mod_lanebs/modal_search"),_defineProperty(ModalSearch,"TEMPLATE","mod_lanebs/modal_search"),_defineProperty(ModalSearch,"SELECTORS",{SEARCH_TEXTBOX:"[data-action='search_text']",START_SEARCH:"[data-action='search_button']",START_SEARCH_CLEAR:"[name='clear_search']",CANCEL_BUTTON:"[data-action='cancel']",CLOSE_CROSS:".close",CONTENT_BLOCK:"[data-action='content_block']",BREADCRUMBS:".breadcrumbs p",CONTENT_NAME:"[name='content_name']",TRIGGER_BOOK:".trigger_book",ADD_BOOK:"[name='add_book']",CATEGORY_BUTTON:"[data-action='category_tree']",CATEGORY_BLOCK:"[data-action='categories']",BOOK_PAGINATION:"#books_pagination li.page-item",START_PAGE_CLASS:"page-start",END_PAGE_CLASS:"page-end",PROGRESS:".loader",BOOK_FILTER:".book_filter",EDU_FILTER:".edu_filter",SEARCH_FORM:"#search_form"}),_defineProperty(ModalSearch,"OUTER_SELECTORS",{PAGE_NUMBER_FIELD:"#id_page_number",NAME_FIELD:"#id_name",CONTENT_FIELD:"[name='content']"}),_defineProperty(ModalSearch,"LIMIT_ON_PAGE",10),_defineProperty(ModalSearch,"breadcrumbs",{}),_defineProperty(ModalSearch,"strings",{}),_defineProperty(ModalSearch,"nameFieldFill",(()=>{const id=(0,_jquery.default)(ModalSearch.OUTER_SELECTORS.CONTENT_FIELD).val(),name=(0,_jquery.default)(ModalSearch.OUTER_SELECTORS.NAME_FIELD).val();if(""===id&&""!==name)window.console.log(ModalSearch.strings.lanebs_error_book);else{let page=(0,_jquery.default)(ModalSearch.OUTER_SELECTORS.PAGE_NUMBER_FIELD).val(),args={id:id,page:page};ModalSearch.getAjaxCall("mod_lanebs_toc_name",args,(function(response){let tocName=response;if(void 0!==tocName&&"1"!==page){let name=(0,_jquery.default)(ModalSearch.OUTER_SELECTORS.NAME_FIELD).val(),pg=ModalSearch.strings.lanebs_read_pg,regexp=new RegExp(", "+pg+".+","gi");(0,_jquery.default)(ModalSearch.OUTER_SELECTORS.NAME_FIELD).val(name.replace(regexp,"")+", "+pg+"."+page+", "+tocName)}}))}})),_defineProperty(ModalSearch,"printCategories",(response=>{(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).empty(),_jquery.default.each(response.body.items,(function(number,item){if(!1===item.available)return!1;(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).append('<div style="cursor:pointer;color:#174c8d;background-color:white;" class="item btn-sm" data-id="'+item.id+'" data-expand="'+item.hasChild+'" data-parent="'+item.parent_id+'"><span>'+item.name+"</span></div>"),(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).find('[data-id="'+item.id+'"]').click({item:item},(function(e){e.stopPropagation(),e.preventDefault();let id=(0,_jquery.default)(e.currentTarget).attr("data-id");if((0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).attr("data-id",id),ModalSearch.clearCurrentCrumb(response.body.items),ModalSearch.breadcrumbs[(0,_jquery.default)(this).find("span").text()]=item,item.hasChild){let args={categoryId:[id]};ModalSearch.getAjaxCall("mod_lanebs_category_tree",args,ModalSearch.printCategories)}else if((0,_jquery.default)(this).hasClass("bg-primary")){(0,_jquery.default)(this).removeClass("bg-primary");let parentId=(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).find(".item:last").attr("data-parent");(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).attr("data-id",parentId),id=parentId,ModalSearch.clearCurrentCrumb(response.body.items)}else(0,_jquery.default)(this).addClass("bg-primary"),(0,_jquery.default)(this).siblings().removeClass("bg-primary"),(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).attr("data-id",id);ModalSearch.printBreadcrumbs(),(0,_jquery.default)(ModalSearch.SELECTORS.START_SEARCH).trigger("click")}))}));let parent_id=(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).find(".item:last").attr("data-parent");(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).prepend('<div style="cursor:pointer;margin-bottom:15px;color:#174c8d;background-color:white;" class="btn-sm category_back" data-id="'+parent_id+'"><span>'+ModalSearch.strings.lanebs_BACK+"</span></div>"),(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).find(".category_back").on("click",(function(){let parent_id=(0,_jquery.default)(this).attr("data-id"),id=ModalSearch.searchParentId(parent_id);null===id&&(id="null"),(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).attr("data-id",id);let args={categoryId:[id]};(0,_jquery.default)(ModalSearch.SELECTORS.CATEGORY_BLOCK).find(".item.bg-primary").length>0?ModalSearch.clearCrumbs(2):ModalSearch.clearCrumbs(1),ModalSearch.printBreadcrumbs(),ModalSearch.getAjaxCall("mod_lanebs_category_tree",args,ModalSearch.printCategories)}))})),_defineProperty(ModalSearch,"printBreadcrumbs",(()=>{let crumbs=ModalSearch.breadcrumbs,html="";(0,_jquery.default)(ModalSearch.SELECTORS.BREADCRUMBS).empty(),_jquery.default.each(crumbs,(function(item,number){html+='<span class="item" data-id="'+number.id+'">'+item+"</span> -> "})),html=html.slice(0,-3),(0,_jquery.default)(ModalSearch.SELECTORS.BREADCRUMBS).append(html)})),_defineProperty(ModalSearch,"getAjaxCall",((methodname,args,callback)=>_ajax.default.call([{methodname:methodname,args:args}])[0].then((function(response){return response})).done((function(response){return callback(JSON.parse(response.body)),!0})).fail((function(response){return window.console.log(response),!1})))),_defineProperty(ModalSearch,"resetPagination",(()=>{let maxPage=parseInt((0,_jquery.default)(ModalSearch.SELECTORS.CONTENT_BLOCK).attr("data-page"));(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.prev").closest("li.page-item").addClass("disabled"),(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.prev").closest("li.page-item").attr("data-page",0),(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.active").closest("li.page-item").attr("data-page",1),(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.next").closest("li.page-item").attr("data-page",2),maxPage>1?((0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.active").text("1 "+ModalSearch.strings.lanebs_from+" "+maxPage),(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.next").closest("li.page-item").removeClass("disabled")):((0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.active").text(maxPage+" "+ModalSearch.strings.lanebs_from+" "+maxPage),(0,_jquery.default)(ModalSearch.SELECTORS.BOOK_PAGINATION).find("a.next").closest("li.page-item").addClass("disabled"))})),_defineProperty(ModalSearch,"clearCurrentCrumb",(data=>{const tmp=ModalSearch.breadcrumbs,lastCrumb=tmp[Object.keys(tmp)[Object.keys(tmp).length-1]];_jquery.default.each(data,(function(number,item){void 0!==lastCrumb&&item.id===lastCrumb.id&&delete ModalSearch.breadcrumbs[item.name]}))})),_defineProperty(ModalSearch,"clearCrumbs",(count=>{let keys=null,last=null;for(let i=0;i<count;i++)keys=Object.keys(ModalSearch.breadcrumbs),last=keys[keys.length-1],delete ModalSearch.breadcrumbs[last]})),_defineProperty(ModalSearch,"searchParentId",(id=>{let parentId=null;return _jquery.default.each(ModalSearch.breadcrumbs,(function(number,item){item.id===id&&(parentId=item.parent_id)})),parentId})),_exports.default}));

//# sourceMappingURL=modal_search.min.js.map