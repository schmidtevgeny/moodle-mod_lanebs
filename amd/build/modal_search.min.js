define("mod_lanebs/modal_search",["exports","jquery","core/ajax","core/modal_factory","core/modal_events","core/notification","core/modal","core/custom_interaction_events","core/modal_registry","core/str","mod_lanebs/modal_book","mod_lanebs/modal_book_handle","mod_lanebs/modal_video"],(function(exports,$,ajax,ModalFactory,ModalEvents,Notification,Modal,CustomEvents,ModalRegistry,Str,ModalBook,ModalBookHandler,ModalVideo){$.fn.serializeAssoc=function(){var data={};return $.each(this.serializeArray(),(function(key,obj){var a=obj.name.match(/(.*?)\[(.*?)\]/);if(null!==a){var subName=a[1],subKey=a[2];data[subName]||(data[subName]=[]),subKey.length||(subKey=data[subName].length),data[subName][subKey]?($.isArray(data[subName][subKey])||(data[subName][subKey]=[]),data[subName][subKey].push(obj.value)):data[subName][subKey]=obj.value}else data[obj.name]?($.isArray(data[obj.name])||(data[obj.name]=[]),data[obj.name].push(obj.value)):data[obj.name]=obj.value})),data};let SELECTORS_SEARCH_TEXTBOX="[data-action='search_text']",SELECTORS_START_SEARCH="[data-action='search_button']",SELECTORS_START_SEARCH_CLEAR="[name='clear_search']",SELECTORS_CANCEL_BUTTON="[data-action='cancel']",SELECTORS_CONTENT_BLOCK="[data-action='content_block']",SELECTORS_BREADCRUMBS=".breadcrumbs p",SELECTORS_CONTENT_NAME="[name='content_name']",SELECTORS_TRIGGER_BOOK=".trigger_book",SELECTORS_ADD_BOOK="[name='add_book']",SELECTORS_CATEGORY_BUTTON="[data-action='category_tree']",SELECTORS_CATEGORY_BLOCK="[data-action='categories']",SELECTORS_BOOK_PAGINATION="#books_pagination li.page-item",SELECTORS_START_PAGE_CLASS="page-start",SELECTORS_END_PAGE_CLASS="page-end",SELECTORS_PROGRESS=".loader",SELECTORS_BOOK_FILTER=".book_filter",SELECTORS_SEARCH_FORM="#search_form",OUTER_SELECTORS_PAGE_NUMBER_FIELD="#id_page_number",OUTER_SELECTORS_NAME_FIELD="#id_name",OUTER_SELECTORS_CONTENT_FIELD="[name='content']",ModalSearch=function(root){Modal.call(this,root),this.getBody().find(SELECTORS_SEARCH_TEXTBOX).length||Str.get_string("lanebs_error_textbox","mod_lanebs").then((function(string){Notification.exception({message:string})})),this.getBody().find(SELECTORS_START_SEARCH).length||Str.get_string("lanebs_error_search","mod_lanebs").then((function(string){Notification.exception({message:string})}))};return ModalSearch.TYPE="mod_lanebs-search",(ModalSearch.prototype=Object.create(Modal.prototype)).constructor=ModalSearch,ModalSearch.prototype.breadcrumbs={},ModalSearch.prototype.registerEventListeners=function(){Modal.prototype.registerEventListeners.call(this);let submitFunction=function(e){e.preventDefault(),e.stopPropagation();let id=$(SELECTORS_CATEGORY_BLOCK).attr("data-id"),args={searchParam:$(e.target.form).serializeAssoc(),page:1,limit:10,catId:id};$(SELECTORS_PROGRESS).toggleClass("hide"),ModalSearch.prototype.getAjaxCall("mod_lanebs_search_books",args,ModalSearch.prototype.getSearchResult).then((function(){ModalSearch.prototype.resetPagination(),$(SELECTORS_PROGRESS).toggleClass("hide")}))};$(OUTER_SELECTORS_PAGE_NUMBER_FIELD).on("change",ModalSearch.prototype.nameFieldFill),this.getModal().on(CustomEvents.events.activate,SELECTORS_START_SEARCH,submitFunction.bind(this)),this.getModal().on("click",SELECTORS_START_SEARCH_CLEAR,(function(e){return e.preventDefault(),e.stopPropagation(),$(SELECTORS_SEARCH_TEXTBOX).val(""),$(SELECTORS_START_SEARCH).trigger("click"),!1})),this.getModal().on("keypress",SELECTORS_SEARCH_TEXTBOX,function(e){if(13===e.keyCode)return submitFunction(e),!1}.bind(this)),this.getModal().on(CustomEvents.events.activate,SELECTORS_BOOK_PAGINATION,function(e){if($(e.currentTarget).hasClass("disabled"))return!0;let page,maxPage;maxPage=void 0===$(SELECTORS_CONTENT_BLOCK).attr("data-page")?0:parseInt($(SELECTORS_CONTENT_BLOCK).attr("data-page")),page=$(e.currentTarget).hasClass(SELECTORS_START_PAGE_CLASS)?maxPage>0?1:0:$(e.currentTarget).hasClass(SELECTORS_END_PAGE_CLASS)?maxPage:parseInt($(e.currentTarget).attr("data-page"));let id=$(SELECTORS_CATEGORY_BLOCK).attr("data-id"),args={searchParam:$(SELECTORS_SEARCH_FORM).serializeAssoc(),page:page,limit:10,catId:id},prevPage=$(SELECTORS_BOOK_PAGINATION).find("a.prev").closest("li.page-item"),nextPage=$(SELECTORS_BOOK_PAGINATION).find("a.next").closest("li.page-item"),currentPage=$(SELECTORS_BOOK_PAGINATION).find("a.active").closest("li.page-item");page>=2?($(prevPage).attr("data-page",page-1),$(prevPage).removeClass("disabled")):1===page&&($(prevPage).attr("data-page",page-1),$(prevPage).addClass("disabled")),maxPage===page?$(nextPage).addClass("disabled"):$(nextPage).removeClass("disabled"),$(nextPage).attr("data-page",page+1),$(currentPage).attr("data-page",page),$(currentPage).find("a.active").text(page+" "+ModalSearch.prototype.strings.lanebs_from+" "+maxPage),0!==page&&0!==maxPage&&($(SELECTORS_PROGRESS).toggleClass("hide"),ModalSearch.prototype.getAjaxCall("mod_lanebs_search_books",args,ModalSearch.prototype.getSearchResult).then((function(){$(SELECTORS_PROGRESS).toggleClass("hide")})))}.bind(this)),this.getModal().on("keydown",SELECTORS_CONTENT_NAME,function(e){if(!1!==e.keyCode)return e.preventDefault(),!1}.bind(this)),this.getModal().on(CustomEvents.events.activate,SELECTORS_CANCEL_BUTTON,function(){$(this).trigger("hide")}.bind(this)),this.getModal().on(CustomEvents.events.activate,SELECTORS_CATEGORY_BUTTON,function(e){e.preventDefault(),e.stopPropagation();let args={categoryId:[null]};ModalSearch.prototype.getAjaxCall("mod_lanebs_category_tree",args,ModalSearch.prototype.printCategories)}.bind(this))},ModalSearch.prototype.nameFieldFill=function(){let id=$(OUTER_SELECTORS_CONTENT_FIELD).val(),name=$(OUTER_SELECTORS_NAME_FIELD).val();if(""===id&&""!==name)Notification.exception({message:ModalSearch.prototype.strings.lanebs_error_book}),console.log(ModalSearch.prototype.strings.lanebs_error_book);else{let page=$(OUTER_SELECTORS_PAGE_NUMBER_FIELD).val(),args={id:id,page:page};ModalSearch.prototype.getAjaxCall("mod_lanebs_toc_name",args,(function(response){let tocName=response;if(void 0!==tocName&&"1"!==page){let name=$(OUTER_SELECTORS_NAME_FIELD).val(),pg=ModalSearch.prototype.strings.lanebs_read_pg,regexp=new RegExp(", "+pg+".+","gi");$(OUTER_SELECTORS_NAME_FIELD).val(name.replace(regexp,"")+", "+pg+"."+page+", "+tocName)}}))}},ModalSearch.prototype.padTo2Digits=function(num){return num.toString().padStart(2,"0")},ModalSearch.prototype.formatDate=function(date){return[ModalSearch.prototype.padTo2Digits(date.getDate()),ModalSearch.prototype.padTo2Digits(date.getMonth()+1),date.getFullYear()].join(".")},ModalSearch.prototype.getSearchResult=function(response){$(SELECTORS_CONTENT_BLOCK).empty();let maxPage=Math.ceil(response.body.total/10);response.body.items.length?$.each(response.body.items,(function(number,item){let descriptionBlock='<a class="" data-toggle="collapse" href="#collapseDescription'+item.id+'" role="button">'+ModalSearch.prototype.strings.lanebs_show_desc+'</a><div class="collapse" id="collapseDescription'+item.id+'">'+item.description+"</div>";null!==item.description&&""!==item.description||(item.description="",descriptionBlock=""),$(SELECTORS_CONTENT_BLOCK).append('<div class="item d-flex" data-id="'+item.id+'"><div class="cover" style="flex:0.2;"><img src="'+item.cover+'" class="book_cover" alt="'+ModalSearch.prototype.strings.lanebs_cover+'"></div><div class="item_content" style="flex:0.55;"><span class="book_biblio_record">'+item.biblioRecord.replace(/00.00.0000/,ModalSearch.prototype.formatDate(new Date))+'</span><br><span class="book_author hidden">'+item.author+'</span><span class="book_title hidden">'+item.title+"</span>"+descriptionBlock+'</div><div style="flex:0.25;"><button type="button" name="add_book" class="btn btn-sm ml-3" style="color: #174c8d;background-color: white;border-color: #4285f4;">'+ModalSearch.prototype.strings.lanebs_add+'</button><button type="button" class="trigger_book btn btn-sm ml-3 float-right" style="color: #174c8d;background-color: white;border-color: #4285f4;" data-page="'+item.page_number+'">'+ModalSearch.prototype.strings.lanebs_preshow+'</button><br></div></div><hr style="margin-top:5px;">')})):$(SELECTORS_CONTENT_BLOCK).append('<div class="item">'+ModalSearch.prototype.strings.lanebs_error_empty_search+"</div>"),$(SELECTORS_CONTENT_BLOCK).attr("data-page",maxPage),$(SELECTORS_TRIGGER_BOOK).on("click",(function(e){let id=$(e.target).closest(".item").attr("data-id"),pageNumber="toc"===$(SELECTORS_BOOK_FILTER).val()?$(e.target).attr("data-page"):null;ModalBookHandler.init(e,id,pageNumber)})),$(SELECTORS_ADD_BOOK).on("click",(function(e){let id=$(e.target).closest(".item").attr("data-id"),contentName=$('[name="content_name"]'),biblioRecordField=$('[name="biblio_record"]'),coverField=$('[name="cover"]'),resourceNameField=$("#id_name"),bookTitle=$(e.target).closest(".item").find(".item_content .book_title").text(),bookAuthor=$(e.target).closest(".item").find(".item_content .book_author").text(),bookCover=$(e.target).closest(".item").find(".book_cover").attr("src"),bookBiblioRecord=$(e.target).closest(".item").find(".item_content .book_biblio_record").text();resourceNameField.val(bookAuthor+" - "+bookTitle),contentName.removeClass("is-invalid"),contentName.siblings("#id_error_content_name").text(""),contentName.val(bookTitle),$('[name="content"]').val(id),biblioRecordField.val(bookBiblioRecord),coverField.val(bookCover),$(SELECTORS_CANCEL_BUTTON).trigger("click"),ModalSearch.prototype.nameFieldFill(),ModalVideo.prototype.resetModal()}))},ModalSearch.prototype.printCategories=function(response){$(SELECTORS_CATEGORY_BLOCK).empty(),$.each(response.body.items,(function(number,item){if(!1===item.available)return!1;$(SELECTORS_CATEGORY_BLOCK).append('<div style="cursor:pointer;color:#174c8d;background-color:white;" class="item btn-sm" data-id="'+item.id+'" data-expand="'+item.hasChild+'" data-parent="'+item.parent_id+'"><span>'+item.name+"</span></div>"),$(SELECTORS_CATEGORY_BLOCK).find('[data-id="'+item.id+'"]').click({item:item},(function(e){e.stopPropagation(),e.preventDefault();let id=$(e.currentTarget).attr("data-id");if($(SELECTORS_CATEGORY_BLOCK).attr("data-id",id),ModalSearch.prototype.clearCurrentCrumb(response.body.items),ModalSearch.prototype.breadcrumbs[$(this).find("span").text()]=item,item.hasChild){let args={categoryId:[id]};ModalSearch.prototype.getAjaxCall("mod_lanebs_category_tree",args,ModalSearch.prototype.printCategories)}else if($(this).hasClass("bg-primary")){$(this).removeClass("bg-primary");let parentId=$(SELECTORS_CATEGORY_BLOCK).find(".item:last").attr("data-parent");$(SELECTORS_CATEGORY_BLOCK).attr("data-id",parentId),id=parentId,ModalSearch.prototype.clearCurrentCrumb(response.body.items)}else $(this).addClass("bg-primary"),$(this).siblings().removeClass("bg-primary"),$(SELECTORS_CATEGORY_BLOCK).attr("data-id",id);ModalSearch.prototype.printBreadcrumbs(),$(SELECTORS_START_SEARCH).trigger("click")}))}));let parent_id=$(SELECTORS_CATEGORY_BLOCK).find(".item:last").attr("data-parent");$(SELECTORS_CATEGORY_BLOCK).prepend('<div style="cursor:pointer;margin-bottom:15px;color:#174c8d;background-color:white;" class="btn-sm category_back" data-id="'+parent_id+'"><span>'+ModalSearch.prototype.strings.lanebs_BACK+"</span></div>"),$(SELECTORS_CATEGORY_BLOCK).find(".category_back").on("click",(function(){let parent_id=$(this).attr("data-id"),id=ModalSearch.prototype.searchParentId(parent_id);null===id&&(id="null"),$(SELECTORS_CATEGORY_BLOCK).attr("data-id",id);let args={categoryId:[id]};$(SELECTORS_CATEGORY_BLOCK).find(".item.bg-primary").length>0?ModalSearch.prototype.clearCrumbs(2):ModalSearch.prototype.clearCrumbs(1),ModalSearch.prototype.printBreadcrumbs(),ModalSearch.prototype.getAjaxCall("mod_lanebs_category_tree",args,ModalSearch.prototype.printCategories)}))},ModalSearch.prototype.printBreadcrumbs=function(){let crumbs=ModalSearch.prototype.breadcrumbs,html="";$(SELECTORS_BREADCRUMBS).empty(),$.each(crumbs,(function(item,number){html+='<span class="item" data-id="'+number.id+'">'+item+"</span> -> "})),html=html.slice(0,-3),$(SELECTORS_BREADCRUMBS).append(html)},ModalSearch.prototype.getAjaxCall=function(methodname,args,callback){return ajax.call([{methodname:methodname,args:args}])[0].then((function(response){return response})).done((function(response){return callback(JSON.parse(response.body)),!0})).fail((function(response){return console.log(response),!1}))},ModalSearch.prototype.resetPagination=function(){let maxPage=parseInt($(SELECTORS_CONTENT_BLOCK).attr("data-page"));$(SELECTORS_BOOK_PAGINATION).find("a.prev").closest("li.page-item").addClass("disabled"),$(SELECTORS_BOOK_PAGINATION).find("a.prev").closest("li.page-item").attr("data-page",0),$(SELECTORS_BOOK_PAGINATION).find("a.active").closest("li.page-item").attr("data-page",1),$(SELECTORS_BOOK_PAGINATION).find("a.next").closest("li.page-item").attr("data-page",2),maxPage>1?($(SELECTORS_BOOK_PAGINATION).find("a.active").text("1 "+ModalSearch.prototype.strings.lanebs_from+" "+maxPage),$(SELECTORS_BOOK_PAGINATION).find("a.next").closest("li.page-item").removeClass("disabled")):($(SELECTORS_BOOK_PAGINATION).find("a.active").text(maxPage+" "+ModalSearch.prototype.strings.lanebs_from+" "+maxPage),$(SELECTORS_BOOK_PAGINATION).find("a.next").closest("li.page-item").addClass("disabled"))},ModalSearch.prototype.clearCurrentCrumb=function(data){let tmp=ModalSearch.prototype.breadcrumbs,lastCrumb=tmp[Object.keys(tmp)[Object.keys(tmp).length-1]];$.each(data,(function(number,item){void 0!==lastCrumb&&item.id===lastCrumb.id&&delete ModalSearch.prototype.breadcrumbs[item.name]}))},ModalSearch.prototype.clearCrumbs=function(count){let keys=null,last=null;for(let i=0;i<count;i++)keys=Object.keys(ModalSearch.prototype.breadcrumbs),last=keys[keys.length-1],delete ModalSearch.prototype.breadcrumbs[last]},ModalSearch.prototype.searchParentId=function(id){let parentId=null;return $.each(ModalSearch.prototype.breadcrumbs,(function(number,item){item.id==id&&(parentId=item.parent_id)})),parentId},ModalRegistry.register(ModalSearch.TYPE,ModalSearch,"mod_lanebs/modal_search"),ModalSearch}));

//# sourceMappingURL=modal_search.min.js.map