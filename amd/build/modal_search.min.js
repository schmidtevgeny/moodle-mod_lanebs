define ("mod_lanebs/modal_search",["exports","jquery","core/ajax","core/modal_factory","core/modal_events","core/notification","core/modal","core/custom_interaction_events","core/modal_registry","core/str","mod_lanebs/modal_book","mod_lanebs/modal_book_handle","mod_lanebs/modal_video"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){b.fn.serializeAssoc=function(){var c={};b.each(this.serializeArray(),function(d,e){var f=e.name.match(/(.*?)\[(.*?)\]/);if(null!==f){var a=f[1],g=f[2];if(!c[a]){c[a]=[]}if(!g.length){g=c[a].length}if(c[a][g]){if(b.isArray(c[a][g])){c[a][g].push(e.value)}else{c[a][g]=[];c[a][g].push(e.value)}}else{c[a][g]=e.value}}else{if(c[e.name]){if(b.isArray(c[e.name])){c[e.name].push(e.value)}else{c[e.name]=[];c[e.name].push(e.value)}}else{c[e.name]=e.value}}});return c};var n={SEARCH_TEXTBOX:"[data-action='search_text']",START_SEARCH:"[data-action='search_button']",START_SEARCH_CLEAR:"[name='clear_search']",CANCEL_BUTTON:"[data-action='cancel_button']",CONTENT_BLOCK:"[data-action='content_block']",BREADCRUMBS:".breadcrumbs p",CONTENT_NAME:"[name='content_name']",TRIGGER_BOOK:".trigger_book",ADD_BOOK:"[name='add_book']",CATEGORY_BUTTON:"[data-action='category_tree']",CATEGORY_BLOCK:"[data-action='categories']",BOOK_PAGINATION:"#books_pagination li.page-item",START_PAGE_CLASS:"page-start",END_PAGE_CLASS:"page-end",PROGRESS:".loader",BOOK_FILTER:".book_filter",EDU_FILTER:".edu_filter",SEARCH_FORM:"#search_form"},o={PAGE_NUMBER_FIELD:"#id_page_number",NAME_FIELD:"#id_name",CONTENT_FIELD:"[name='content']"},p=10,q=function(a){g.call(this,a);if(!this.getBody().find(n.SEARCH_TEXTBOX).length){j.get_string("lanebs_error_textbox","mod_lanebs").then(function(a){f.exception({message:a})})}if(!this.getBody().find(n.START_SEARCH).length){j.get_string("lanebs_error_search","mod_lanebs").then(function(a){f.exception({message:a})})}};q.TYPE="mod_lanebs-search";q.prototype=Object.create(g.prototype);q.prototype.constructor=q;q.prototype.breadcrumbs={};q.prototype.registerEventListeners=function(){g.prototype.registerEventListeners.call(this);var a=function(a){a.preventDefault();a.stopPropagation();var c=b(n.CATEGORY_BLOCK).attr("data-id"),d={searchParam:b(a.target.form).serializeAssoc(),page:1,limit:p,catId:c};b(n.PROGRESS).toggleClass("hide");q.prototype.getAjaxCall("mod_lanebs_search_books",d,q.prototype.getSearchResult).then(function(){q.prototype.resetPagination();b(n.PROGRESS).toggleClass("hide")})};b(o.PAGE_NUMBER_FIELD).on("change",q.prototype.nameFieldFill);this.getModal().on(h.events.activate,n.START_SEARCH,a.bind(this));this.getModal().on("click",n.START_SEARCH_CLEAR,function(a){a.preventDefault();a.stopPropagation();b(n.SEARCH_TEXTBOX).val("");b(n.START_SEARCH).trigger("click");return!1});this.getModal().on("keypress",n.SEARCH_TEXTBOX,function disabledEnterSubmit(b){if(13===b.keyCode){a(b);return!1}}.bind(this));this.getModal().on(h.events.activate,n.BOOK_PAGINATION,function setPagination(a){if(b(a.currentTarget).hasClass("disabled")){return!0}var c,d;if(b(n.CONTENT_BLOCK).attr("data-page")===void 0){d=0}else{d=parseInt(b(n.CONTENT_BLOCK).attr("data-page"))}if(b(a.currentTarget).hasClass(n.START_PAGE_CLASS)){if(0<d){c=1}else{c=0}}else if(b(a.currentTarget).hasClass(n.END_PAGE_CLASS)){c=d}else{c=parseInt(b(a.currentTarget).attr("data-page"))}var e=b(n.CATEGORY_BLOCK).attr("data-id"),f={searchParam:b(n.SEARCH_FORM).serializeAssoc(),page:c,limit:p,catId:e},g=b(n.BOOK_PAGINATION).find("a.prev").closest("li.page-item"),h=b(n.BOOK_PAGINATION).find("a.next").closest("li.page-item"),i=b(n.BOOK_PAGINATION).find("a.active").closest("li.page-item");if(2<=c){b(g).attr("data-page",c-1);b(g).removeClass("disabled")}else if(1===c){b(g).attr("data-page",c-1);b(g).addClass("disabled")}if(d===c){b(h).addClass("disabled")}else{b(h).removeClass("disabled")}b(h).attr("data-page",c+1);b(i).attr("data-page",c);b(i).find("a.active").text(c+" "+q.prototype.strings.lanebs_from+" "+d);if(0!==c&&0!==d){b(n.PROGRESS).toggleClass("hide");q.prototype.getAjaxCall("mod_lanebs_search_books",f,q.prototype.getSearchResult).then(function(){b(n.PROGRESS).toggleClass("hide")})}}.bind(this));this.getModal().on("keydown",n.CONTENT_NAME,function disabledKeyUp(a){if(!1!==a.keyCode){a.preventDefault();return!1}}.bind(this));this.getModal().on(h.events.activate,n.CANCEL_BUTTON,function(){b(this).trigger("hide")}.bind(this));this.getModal().on(h.events.activate,n.CATEGORY_BUTTON,function getCategoryTree(a){a.preventDefault();a.stopPropagation();q.prototype.getAjaxCall("mod_lanebs_category_tree",{categoryId:[null]},q.prototype.printCategories)}.bind(this))};q.prototype.nameFieldFill=function(){var a=b(o.CONTENT_FIELD).val(),c=b(o.NAME_FIELD).val();if(""===a&&""!==c){f.exception({message:q.prototype.strings.lanebs_error_book});console.log(q.prototype.strings.lanebs_error_book)}else{var d=b(o.PAGE_NUMBER_FIELD).val();q.prototype.getAjaxCall("mod_lanebs_toc_name",{id:a,page:d},function(a){var c=a;if(c!==void 0&&"1"!==d){var e=b(o.NAME_FIELD).val(),f=q.prototype.strings.lanebs_read_pg,g=new RegExp(", "+f+".+","gi");b(o.NAME_FIELD).val(e.replace(g,"")+", "+f+"."+d+", "+c)}})}};q.prototype.padTo2Digits=function(a){return a.toString().padStart(2,"0")};q.prototype.formatDate=function(a){return[q.prototype.padTo2Digits(a.getDate()),q.prototype.padTo2Digits(a.getMonth()+1),a.getFullYear()].join(".")};q.prototype.getSearchResult=function(a){b(n.CONTENT_BLOCK).empty();var c=Math.ceil(a.body.total/p);if(a.body.items.length){b.each(a.body.items,function(a,c){var d="<a class=\"\" data-toggle=\"collapse\" href=\"#collapseDescription"+c.id+"\" role=\"button\">"+q.prototype.strings.lanebs_show_desc+"</a><div class=\"collapse\" id=\"collapseDescription"+c.id+"\">"+c.description+"</div>";if(null===c.description||""===c.description){c.description="";d=""}b(n.CONTENT_BLOCK).append("<div class=\"item d-flex\" data-id=\""+c.id+"\"><div class=\"cover\" style=\"flex:0.2;\"><img src=\""+c.cover+"\" class=\"book_cover\" alt=\""+q.prototype.strings.lanebs_cover+"\"></div><div class=\"item_content\" style=\"flex:0.55;\"><span class=\"book_biblio_record\">"+c.biblioRecord.replace(/00.00.0000/,q.prototype.formatDate(new Date))+"</span><br><span class=\"book_author hidden\">"+c.author+"</span><span class=\"book_title hidden\">"+c.title+"</span>"+d+"</div><div style=\"flex:0.25;\"><button type=\"button\" name=\"add_book\" class=\"btn btn-sm ml-3\" style=\"color: #174c8d;background-color: white;border-color: #4285f4;\">"+q.prototype.strings.lanebs_add+"</button><button type=\"button\" class=\"trigger_book btn btn-sm ml-3 float-right\" style=\"color: #174c8d;background-color: white;border-color: #4285f4;\">"+q.prototype.strings.lanebs_preshow+"</button><br></div></div><hr style=\"margin-top:5px;\">")})}else{b(n.CONTENT_BLOCK).append("<div class=\"item\">"+q.prototype.strings.lanebs_error_empty_search+"</div>")}b(n.CONTENT_BLOCK).attr("data-page",c);b(n.TRIGGER_BOOK).on("click",function(a){var c=b(a.target).closest(".item").attr("data-id");l.init(a,c)});b(n.ADD_BOOK).on("click",function(a){var c=b(a.target).closest(".item").attr("data-id"),d=b("[name=\"content_name\"]"),e=b("[name=\"biblio_record\"]"),f=b("[name=\"cover\"]"),g=b("#id_name"),h=b(a.target).closest(".item").find(".item_content .book_title").text(),i=b(a.target).closest(".item").find(".item_content .book_author").text(),j=b(a.target).closest(".item").find(".book_cover").attr("src"),k=b(a.target).closest(".item").find(".item_content .book_biblio_record").text();g.val(i+" - "+h);d.removeClass("is-invalid");d.siblings("#id_error_content_name").text("");d.val(h);b("[name=\"content\"]").val(c);e.val(k);f.val(j);b(n.CANCEL_BUTTON).trigger("click");q.prototype.nameFieldFill();m.prototype.resetModal()})};q.prototype.printCategories=function(a){b(n.CATEGORY_BLOCK).empty();b.each(a.body.items,function(c,d){if(!1===d.available){return!1}b(n.CATEGORY_BLOCK).append("<div style=\"cursor:pointer;color:#174c8d;background-color:white;\" class=\"item btn-sm\" data-id=\""+d.id+"\" data-expand=\""+d.hasChild+"\" data-parent=\""+d.parent_id+"\"><span>"+d.name+"</span></div>");b(n.CATEGORY_BLOCK).find("[data-id=\""+d.id+"\"]").click({item:d},function(c){c.stopPropagation();c.preventDefault();var e=b(c.currentTarget).attr("data-id");b(n.CATEGORY_BLOCK).attr("data-id",e);q.prototype.clearCurrentCrumb(a.body.items);q.prototype.breadcrumbs[b(this).find("span").text()]=d;if(d.hasChild){var f={categoryId:[e]};q.prototype.getAjaxCall("mod_lanebs_category_tree",f,q.prototype.printCategories)}else{if(b(this).hasClass("bg-primary")){b(this).removeClass("bg-primary");var g=b(n.CATEGORY_BLOCK).find(".item:last").attr("data-parent");b(n.CATEGORY_BLOCK).attr("data-id",g);e=g;q.prototype.clearCurrentCrumb(a.body.items)}else{b(this).addClass("bg-primary");b(this).siblings().removeClass("bg-primary");b(n.CATEGORY_BLOCK).attr("data-id",e)}}q.prototype.printBreadcrumbs();b(n.START_SEARCH).trigger("click")})});var c=b(n.CATEGORY_BLOCK).find(".item:last").attr("data-parent");b(n.CATEGORY_BLOCK).prepend("<div style=\"cursor:pointer;margin-bottom:15px;color:#174c8d;background-color:white;\" class=\"btn-sm category_back\" data-id=\""+c+"\"><span>"+q.prototype.strings.lanebs_BACK+"</span></div>");b(n.CATEGORY_BLOCK).find(".category_back").on("click",function(){var a=b(this).attr("data-id"),c=q.prototype.searchParentId(a);if(null===c){c="null"}b(n.CATEGORY_BLOCK).attr("data-id",c);var d={categoryId:[c]};if(0<b(n.CATEGORY_BLOCK).find(".item.bg-primary").length){q.prototype.clearCrumbs(2)}else{q.prototype.clearCrumbs(1)}q.prototype.printBreadcrumbs();q.prototype.getAjaxCall("mod_lanebs_category_tree",d,q.prototype.printCategories)})};q.prototype.printBreadcrumbs=function(){var a=q.prototype.breadcrumbs,c="";b(n.BREADCRUMBS).empty();b.each(a,function(a,b){c+="<span class=\"item\" data-id=\""+b.id+"\">"+a+"</span> -> "});c=c.slice(0,-3);b(n.BREADCRUMBS).append(c)};q.prototype.getAjaxCall=function(a,b,d){return c.call([{methodname:a,args:b}])[0].then(function(a){return a}).done(function(a){d(JSON.parse(a.body));return!0}).fail(function(a){console.log(a);return!1})};q.prototype.resetPagination=function(){var a=parseInt(b(n.CONTENT_BLOCK).attr("data-page"));b(n.BOOK_PAGINATION).find("a.prev").closest("li.page-item").addClass("disabled");b(n.BOOK_PAGINATION).find("a.prev").closest("li.page-item").attr("data-page",0);b(n.BOOK_PAGINATION).find("a.active").closest("li.page-item").attr("data-page",1);b(n.BOOK_PAGINATION).find("a.next").closest("li.page-item").attr("data-page",2);if(1<a){b(n.BOOK_PAGINATION).find("a.active").text("1 "+q.prototype.strings.lanebs_from+" "+a);b(n.BOOK_PAGINATION).find("a.next").closest("li.page-item").removeClass("disabled")}else{b(n.BOOK_PAGINATION).find("a.active").text(a+" "+q.prototype.strings.lanebs_from+" "+a);b(n.BOOK_PAGINATION).find("a.next").closest("li.page-item").addClass("disabled")}};q.prototype.clearCurrentCrumb=function(a){var c=q.prototype.breadcrumbs,d=c[Object.keys(c)[Object.keys(c).length-1]];b.each(a,function(a,b){if(void 0!==d){if(b.id===d.id){delete q.prototype.breadcrumbs[b.name]}}})};q.prototype.clearCrumbs=function(a){for(var b=null,c=null,d=0;d<a;d++){b=Object.keys(q.prototype.breadcrumbs);c=b[b.length-1];delete q.prototype.breadcrumbs[c]}};q.prototype.searchParentId=function(a){var c=null;b.each(q.prototype.breadcrumbs,function(b,d){if(d.id==a){c=d.parent_id}});return c};i.register(q.TYPE,q,"mod_lanebs/modal_search");return q});
//# sourceMappingURL=modal_search.min.js.map
