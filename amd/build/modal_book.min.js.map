{"version":3,"sources":["../src/modal_book.js"],"names":["define","exports","$","ajax","ModalFactory","ModalEvents","Notification","Modal","CustomEvents","ModalRegistry","Str","SELECTORS","CLOSE_BUTTON","CONTENT_BLOCK","CLOSE_CROSS","ROOT_MODAL","CONTAINER","MODAL","ModalBook","root","call","getFooter","find","length","exception","message","get_string","TYPE","prototype","Object","create","constructor","registerEventListeners","getModal","on","events","activate","e","preventDefault","stopPropagation","getRoot","trigger","remove","bind","click","target","closest","scrollBottom","agent","navigator","userAgent","toLowerCase","mobile","match","window","innerWidth","id","currentTarget","attr","methodname","args","then","response","done","pageNumber","getBookResult","fail","console","log","bookId","iframeBook","document","getElementById","register"],"mappings":"AAAAA,OAAM,yBAAC,CACH,SADG,CAEH,QAFG,CAGH,WAHG,CAIH,oBAJG,CAKH,mBALG,CAMH,mBANG,CAOH,YAPG,CAQH,gCARG,CASH,qBATG,CAUH,UAVG,CAAD,CAWH,SACCC,CADD,CAECC,CAFD,CAGCC,CAHD,CAICC,CAJD,CAKCC,CALD,CAMCC,CAND,CAOCC,CAPD,CAQCC,CARD,CASCC,CATD,CAUCC,CAVD,CAWD,IACMC,CAAAA,CAAS,CAAG,CACZC,YAAY,CAAE,8BADF,CAEZC,aAAa,CAAE,oCAFH,CAGZC,WAAW,CAAE,QAHD,CAIZC,UAAU,CAAE,iCAJA,CAKZC,SAAS,CAAE,iCALC,CAMZC,KAAK,CAAE,uBANK,CADlB,CAcMC,CAAS,CAAG,SAASC,CAAT,CAAe,CAC3BZ,CAAK,CAACa,IAAN,CAAW,IAAX,CAAiBD,CAAjB,EAEA,GAAI,CAAC,KAAKE,SAAL,GAAiBC,IAAjB,CAAsBX,CAAS,CAACC,YAAhC,EAA8CW,MAAnD,CAA2D,CACvDjB,CAAY,CAACkB,SAAb,CAAuB,CAACC,OAAO,CAAEf,CAAG,CAACgB,UAAJ,CAAe,oBAAf,CAAqC,YAArC,CAAV,CAAvB,CACH,CACJ,CApBH,CAsBER,CAAS,CAACS,IAAV,CAAiB,iBAAjB,CACAT,CAAS,CAACL,aAAV,CAA0BF,CAAS,CAACE,aAApC,CACAK,CAAS,CAACU,SAAV,CAAsBC,MAAM,CAACC,MAAP,CAAcvB,CAAK,CAACqB,SAApB,CAAtB,CACAV,CAAS,CAACU,SAAV,CAAoBG,WAApB,CAAkCb,CAAlC,CAEAA,CAAS,CAACU,SAAV,CAAoBI,sBAApB,CAA6C,UAAY,CACrDzB,CAAK,CAACqB,SAAN,CAAgBI,sBAAhB,CAAuCZ,IAAvC,CAA4C,IAA5C,EACA,KAAKa,QAAL,GAAgBC,EAAhB,CAAmB1B,CAAY,CAAC2B,MAAb,CAAoBC,QAAvC,CAAiDzB,CAAS,CAACC,YAAV,CAAuB,IAAvB,CAA4BD,CAAS,CAACG,WAAvF,CAAoG,SAAUuB,CAAV,CAAa,CAC7GA,CAAC,CAACC,cAAF,GACAD,CAAC,CAACE,eAAF,GACA,KAAKC,OAAL,GAAeC,OAAf,CAAuB,OAAvB,EACA,KAAKR,QAAL,GAAgBS,MAAhB,GACA,KAAKF,OAAL,GAAeE,MAAf,GACA,QACH,CAPmG,CAOlGC,IAPkG,CAO7F,IAP6F,CAApG,EASA,KAAKH,OAAL,GAAeI,KAAf,CAAqB,SAASP,CAAT,CAAY,CAC7B,GAAI,CAACnC,CAAC,CAACmC,CAAC,CAACQ,MAAH,CAAD,CAAYC,OAAZ,CAAoBnC,CAAS,CAACM,KAA9B,EAAqCM,MAA1C,CAAkD,CAC9C,GAAIrB,CAAC,CAACmC,CAAC,CAACQ,MAAH,CAAD,CAAYC,OAAZ,CAAoBnC,CAAS,CAACK,SAA9B,EAAyCO,MAA7C,CAAqD,CACjD,KAAKU,QAAL,GAAgBS,MAAhB,GACA,KAAKF,OAAL,GAAeE,MAAf,EACH,CACJ,CACD,QACH,CARoB,CAQnBC,IARmB,CAQd,IARc,CAArB,EAUA,KAAKV,QAAL,GAAgBC,EAAhB,CAAmB1B,CAAY,CAAC2B,MAAb,CAAoBY,YAAvC,CAAqDpC,CAAS,CAACE,aAA/D,CAA8E,SAAUwB,CAAV,CAAa,IACnFW,CAAAA,CAAK,CAAGC,SAAS,CAACC,SAAV,CAAoBC,WAApB,EAD2E,CAEnFC,CAAM,CAAG,CAAC,CAACJ,CAAK,CAACK,KAAN,CAAY,wIAAZ,CAFwE,CAGvFD,CAAM,CAAGA,CAAM,EAAyB,IAApB,CAAAE,MAAM,CAACC,UAA3B,CACA,GAAIC,CAAAA,CAAE,CAAGtD,CAAC,CAACmC,CAAC,CAACoB,aAAH,CAAD,CAAmBC,IAAnB,CAAwB,SAAxB,CAAT,CACAvD,CAAI,CAACiB,IAAL,CAAU,CACV,CACIuC,UAAU,CAAE,yBADhB,CAEIC,IAAI,CAAE,CACFJ,EAAE,CAAEA,CADF,CAEFJ,MAAM,CAAEA,CAFN,CAFV,CADU,CAAV,EAQG,CARH,EAQMS,IARN,CAQW,SAAUC,CAAV,CAAoB,CAC3B,MAAOA,CAAAA,CACV,CAVD,EAWAC,IAXA,CAWK,SAAUD,CAAV,CAAoB,CACrB,GAAIE,CAAAA,CAAU,CAAG9D,CAAC,CAACS,CAAS,CAACE,aAAX,CAAD,CAA2B6C,IAA3B,CAAgC,WAAhC,CAAjB,CACAxC,CAAS,CAACU,SAAV,CAAoBqC,aAApB,CAAkCH,CAAQ,KAA1C,CAAoDE,CAApD,CAAgER,CAAhE,CACH,CAdD,EAcGU,IAdH,CAcQ,SAAUJ,CAAV,CAAoB,CACxBK,OAAO,CAACC,GAAR,CAAYN,CAAZ,CACH,CAhBD,CAiBH,CAtBD,CAuBH,CA5CD,CA8CA5C,CAAS,CAACU,SAAV,CAAoBqC,aAApB,CAAoC,SAAUH,CAAV,CAAoBE,CAApB,CAAgCK,CAAhC,CAAwC,IACpEC,CAAAA,CAAU,CAAGC,QAAQ,CAACC,cAAT,CAAwB,aAAxB,CADuD,CAIxEtE,CAAC,CAACoE,CAAD,CAAD,CAAcZ,IAAd,CAAmB,KAAnB,CAFiB,kCACD,CAAWW,CAAX,CAAkB,YAAlB,CAA+BP,CAA/B,uBAAiEE,CACjF,CAaH,CAjBD,CAmBAvD,CAAa,CAACgE,QAAd,CAAuBvD,CAAS,CAACS,IAAjC,CAAuCT,CAAvC,CAAkD,uBAAlD,EAEA,MAAOA,CAAAA,CAEV,CAtHK,CAAN","sourcesContent":["define([\n    \"exports\",\n    \"jquery\",\n    \"core/ajax\",\n    \"core/modal_factory\",\n    \"core/modal_events\",\n    \"core/notification\",\n    \"core/modal\",\n    \"core/custom_interaction_events\",\n    \"core/modal_registry\",\n    \"core/str\",\n], function (\n    exports,\n    $,\n    ajax,\n    ModalFactory,\n    ModalEvents,\n    Notification,\n    Modal,\n    CustomEvents,\n    ModalRegistry,\n    Str,\n) {\n    let SELECTORS = {\n        CLOSE_BUTTON: \"[data-action='close_button']\",\n        CONTENT_BLOCK: \"[data-action='book_content_block']\",\n        CLOSE_CROSS: \".close\",\n        ROOT_MODAL: \"[data-region='modal-container']\",\n        CONTAINER: \"[data-region='modal-container']\",\n        MODAL: \"[data-region='modal']\",\n    };\n\n    /**\n     * Constructor for the Modal\n     *\n     */\n    let ModalBook = function(root) {\n        Modal.call(this, root);\n\n        if (!this.getFooter().find(SELECTORS.CLOSE_BUTTON).length) {\n            Notification.exception({message: Str.get_string('lanebs_error_close', 'mod_lanebs')});\n        }\n    };\n\n    ModalBook.TYPE = 'mod_lanebs-book';\n    ModalBook.CONTENT_BLOCK = SELECTORS.CONTENT_BLOCK;\n    ModalBook.prototype = Object.create(Modal.prototype);\n    ModalBook.prototype.constructor = ModalBook;\n\n    ModalBook.prototype.registerEventListeners = function () {\n        Modal.prototype.registerEventListeners.call(this);\n        this.getModal().on(CustomEvents.events.activate, SELECTORS.CLOSE_BUTTON+', '+SELECTORS.CLOSE_CROSS, function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            this.getRoot().trigger('click');\n            this.getModal().remove();\n            this.getRoot().remove();\n            return true;\n        }.bind(this));\n\n        this.getRoot().click(function(e) {\n            if (!$(e.target).closest(SELECTORS.MODAL).length) {\n                if ($(e.target).closest(SELECTORS.CONTAINER).length) {\n                    this.getModal().remove();\n                    this.getRoot().remove();\n                }\n            }\n            return true;\n        }.bind(this));\n\n        this.getModal().on(CustomEvents.events.scrollBottom, SELECTORS.CONTENT_BLOCK, function (e) {\n            let agent = navigator.userAgent.toLowerCase();\n            let mobile = !!agent.match(/(android|avantgo|blackberry|bolt|boost|cricket|docomo|fone|hiptop|mini|mobi|palm|phone|pie|tablet|up\\.browser|up\\.link|webos|wos|ios)/g);\n            mobile = mobile || (window.innerWidth < 1006); // kostil for ignore redirect window.location.origin + '/m'\n            let id = $(e.currentTarget).attr('data-id');\n            ajax.call([\n            {\n                methodname: 'mod_lanebs_book_content',\n                args: {\n                    id: id,\n                    mobile: mobile\n                }\n            }\n            ])[0].then(function (response) {\n                return response;\n            }).\n            done(function (response) {\n                let pageNumber = $(SELECTORS.CONTENT_BLOCK).attr('data-page');\n                ModalBook.prototype.getBookResult(response['body'], pageNumber, id);\n            }).fail(function (response) {\n                console.log(response);\n            });\n        });\n    };\n\n    ModalBook.prototype.getBookResult = function (response, pageNumber, bookId) {\n        let iframeBook = document.getElementById('book_iframe');\n        let readerBase = 'https://reader.lanbook.com/book/';//'https://reader.landev.ru/book/';\n        let readerUrl = readerBase+bookId+'?jwtToken='+response+'&mode=moodlePlugin'+'#'+pageNumber;\n        $(iframeBook).attr('src', readerUrl);\n        //iframeBook.contentWindow.document.open();\n        //iframeBook.contentWindow.location.hash = '#' + pageNumber;\n        //iframeBook.contentWindow.document.write(response);\n        //iframeBook.contentWindow.document.close();\n        // for change reader scale after loading\n        // some kostil...\n        /*let timer = setInterval(function() {\n            if (iframeBook.contentWindow.Reader.Viewer.UIInputZoom !== undefined && iframeBook.contentWindow.Reader.Viewer.pageScale !== undefined) {\n                iframeBook.contentWindow.Reader.Viewer.pageScale(50 * 0.01);\n                clearInterval(timer);\n            }\n        }, 1000);*/\n    };\n\n    ModalRegistry.register(ModalBook.TYPE, ModalBook, 'mod_lanebs/modal_book');\n\n    return ModalBook;\n\n});"],"file":"modal_book.min.js"}