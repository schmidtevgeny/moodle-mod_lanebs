{"version":3,"file":"modal_video.min.js","sources":["../src/modal_video.js"],"sourcesContent":["import Modal from 'core/modal';\nimport $ from 'jquery';\nimport ajax from 'core/ajax';\nimport CustomEvents from 'core/custom_interaction_events';\nimport {init as ModalPlayerHandle} from './modal_player_handle';\n\nexport default class ModalVideo extends Modal {\n    static TYPE = 'mod_lanebs/modal_video';\n    static TEMPLATE = 'mod_lanebs/modal_video';\n    static SELECTORS = {\n        SUBMIT_BUTTON: \".video_submit\",\n        OPEN_BUTTON: \"#id_modal_video_button\",\n        OPEN_BUTTON_CONTAINER: \"#id_modal_video_button\",\n        CANCEL_BUTTON: \".video_close\",\n        CONTENT_BLOCK: \"[data-action='video_content_block']\",\n        CLOSE_CROSS: \".modal_content_lan_reader .close\",\n        ROOT_MODAL: \"[data-region='modal-container']\",\n        DATA_TOC: \"#data-toc\",\n        BOOK_ID_SELECTOR: \"[name='content']\",\n        SEARCH_CLASS: \".modal_video\",\n        VIDEOS_FIELD: \"input[name='videos']\",\n        DELETE_SELECTED: \"span.closes\",\n        PREVIEW_CLASS: \".video-item\",\n        PREVIEW_TEXT: \"span.video_preview\",\n        PREVIEW_CONTAINER: \".video_preview_container\",\n        TRIGGER_PLAYER: \"img.modal_video\",\n        PLAY_BUTTON_HOVER: \".video_play_hover\",\n    };\n    static strings = {};\n\n    configure(modalConfig) {\n        super.configure(modalConfig);\n        ModalVideo.CONTENT_BLOCK = ModalVideo.SELECTORS.CONTENT_BLOCK;\n    }\n\n    registerEventListeners() {\n        // Call the registerEventListeners method on the parent class.\n        super.registerEventListeners();\n        const modal = this;\n        this.getModal().on(CustomEvents.events.activate, ModalVideo.SELECTORS.SUBMIT_BUTTON, ModalVideo.updateVideoField);\n\n        this.getRoot().on(CustomEvents.events.activate, ModalVideo.SELECTORS.CANCEL_BUTTON, (e) => {\n            e.stopPropagation();\n            e.preventDefault();\n            modal.hide();\n        });\n    }\n\n    static printTocs = () => {\n        const bookId = $(ModalVideo.SELECTORS.BOOK_ID_SELECTOR).val();\n        if (bookId !== '') {\n            let tocArgs = {\n                id: bookId,\n                page: 0\n            };\n            ModalVideo.getAjaxCall('mod_lanebs_toc_name', tocArgs, function (tocs) {\n                let videosArgs = {\n                    id: $(ModalVideo.SELECTORS.BOOK_ID_SELECTOR).val()\n                };\n                ModalVideo.getAjaxCall('mod_lanebs_toc_videos', videosArgs, function (videos) {\n                    let innerTocHtml = '';\n                    let issetTocVideo = [];\n                    let BreakException = {};\n                    if (tocs) {\n                        tocs.forEach(function (value, index) {\n                            let videosList = '<ul class=\"modal_video\">';\n                            let currentPage = value['page'];\n                            issetTocVideo[index] = false;\n                            let uniqueIndex;\n                            try {\n                                videos.forEach(function (video) {\n                                    if (video['start_page'] === currentPage) {\n                                        issetTocVideo[index] = true;\n                                        uniqueIndex = video['unique_id'] + '_' + index;\n                                        videosList +=\n                                            '<li class=\"modal_video\">' +\n                                            '<label for=\"video_' + uniqueIndex + '\" class=\"modal_video\">' +\n                                            '<p class=\"modal_video\">' +\n                                            '<input type=\"checkbox\" data-unique=\"' + uniqueIndex + '\" class=\"modal_video\"' +\n                                            ' id=\"video_' + uniqueIndex + '\" data-url=\"' + video['link_url'] + '\" />' +\n                                            video['link_name'] +\n                                            '</p>' +\n                                            '<img src=\"' + ModalVideo.getYoutubePreview(video['link_url']) + '\" alt=\"' +\n                                            video['link_name'] + '\" class=\"modal_video\" data-id=\"' +\n                                            ModalVideo.getYoutubeId(video['link_url']) + '\" />' +\n                                            '<div class=\"video_play_hover\"></div>' +\n                                            '</label>' +\n                                            '</li>';\n                                    } else if (video['start_page'] === '-1') {\n                                        issetTocVideo[index] = undefined;\n                                        $(ModalVideo.SELECTORS.OPEN_BUTTON_CONTAINER).closest('.form-group').addClass('hidden');\n                                        throw BreakException;\n                                    }\n                                });\n                            } catch (e) {\n                                if (e !== BreakException) {\n                                    throw e;\n                                }\n                            }\n                            videosList += '</ul>';\n                            if (issetTocVideo[index] === true) {\n                                innerTocHtml +=\n                                    '<div class=\"item-toc\" style=\"margin-bottom:10px;\" data-page=\"' + currentPage + '\">' +\n                                    '<span>' + value['title'] + ', ' + ModalVideo.strings['lanebs_read_pg'] + '. ' +\n                                    value['page'] + '</span><br>' +\n                                    '<a class=\"\" data-toggle=\"collapse\" href=\"#collapseDescription_' + currentPage + '_' +\n                                    index + '\" role=\"button\">' +\n                                    'Видео-рекомендации' +\n                                    '</a>' +\n                                    '<div class=\"collapse\" id=\"collapseDescription_' + currentPage + '_' + index + '\">' +\n                                    videosList + '</div>' +\n                                    '</div>';\n                            }\n                        });\n                    }\n                    if (issetTocVideo[0] !== undefined) {\n                        $(ModalVideo.SELECTORS.OPEN_BUTTON_CONTAINER).closest('.form-group').removeClass('hidden');\n                        $(ModalVideo.SELECTORS.DATA_TOC).html(innerTocHtml);\n                        $(ModalVideo.SELECTORS.TRIGGER_PLAYER).on('click', function (e) {\n                            let linkId = $(e.target).attr('data-id');\n                            ModalPlayerHandle(e, linkId);\n                        });\n                        $(ModalVideo.SELECTORS.PLAY_BUTTON_HOVER).on('click', function (e) {\n                            e.preventDefault();\n                            e.stopPropagation();\n                            $(e.currentTarget).siblings(ModalVideo.SELECTORS.TRIGGER_PLAYER).trigger('click');\n                        });\n                    }\n                    let issetVideos = ModalVideo.getIssetVideos();\n                    if (issetVideos) {\n                        ModalVideo.printVideos(issetVideos);\n                        ModalVideo.preCheckVideos(issetVideos);\n                    }\n                });\n            });\n        }\n    };\n\n    static getAjaxCall = (methodname, args, callback) => {\n        return ajax.call([\n            {\n                methodname: methodname,\n                args,\n            }\n        ])[0].then(function(response) {\n            callback(JSON.parse(response['body']));\n            return true;\n        }).fail(function (response) {\n            window.console.log(response);\n            return false;\n        });\n    };\n\n    static printVideos = (videos) => {\n        let previewBlock = '<div class=\"col-md-3\"></div><div class=\"container col-md-9\">';\n        videos.forEach(function (value) {\n            previewBlock +=\n                '<div class=\"item video-item row\">' +\n                '<div class=\"img-wraps\">' +\n                '<span class=\"closes\" title=\"Delete\" data-unique=\"'+value['unique']+'\">×</span>' +\n                '<img width=\"100px;\" height=\"100px;\" src=\"'+\n                ModalVideo.getYoutubePreview(value['link'])+'\" alt=\"'+value['name']+'\"' +\n                ' class=\"img-responsive\" src=\"images/image.jpg\" data-id=\"'+ModalVideo.getYoutubeId(value['link'])+'\"/>' +\n                '</div>' +\n                '<span class=\"video_preview\">'+value['name']+'</span>' +\n                '</div>';\n        });\n        previewBlock += '</div>';\n        $(ModalVideo.SELECTORS.PREVIEW_CONTAINER).html(previewBlock);\n        ModalVideo.deleteSelectedEvent();\n    };\n\n    static getYoutubeId = (link) => {\n        let urlParams = link.split('?')[1];\n        return (new URLSearchParams(urlParams)).get('v');\n    };\n\n    static getYoutubePreview = (link) => {\n        let id = ModalVideo.getYoutubeId(link);\n        return 'https://img.youtube.com/vi/'+id+'/0.jpg';\n    };\n\n    static getIssetVideos = () => {\n        let videos = $(ModalVideo.SELECTORS.VIDEOS_FIELD).val();\n        try {\n            return JSON.parse(videos);\n        } catch (e) {\n            window.console.log(e.message);\n            return '';\n        }\n    };\n\n    static preCheckVideos = (videos) => {\n        videos.forEach(function (value) {\n            $(ModalVideo.SELECTORS.ROOT_MODAL).find('input[data-unique=\"'+value['unique']+'\"]').trigger('click');\n        });\n    };\n\n    static deleteSelectedEvent = () => {\n        $(ModalVideo.SELECTORS.DELETE_SELECTED).each(function (index, value) {\n            $(value).on('click', function (e) {\n                let videoItem = $(e.target).closest(ModalVideo.SELECTORS.PREVIEW_CLASS);\n                let videoUnique = $(e.target).attr('data-unique');\n                $(ModalVideo.SELECTORS.ROOT_MODAL).find('input[data-unique=\"'+videoUnique+'\"]').trigger('click');\n                $(videoItem).remove();\n                ModalVideo.updateVideoField();\n            });\n        });\n    };\n\n    static updateVideoField = () => {\n        let videos = [];\n        let inputs = $(ModalVideo.SELECTORS.ROOT_MODAL).find('ul'+ModalVideo.SELECTORS.SEARCH_CLASS+' input:checked');\n        inputs.each(function (index, value) {\n            let url = $(value).attr('data-url');\n            videos.push(\n                {\n                    link: url,\n                    name: $(value).closest('p').text(),\n                    unique: $(value).attr('data-unique'),\n                    video_id: ModalVideo.getYoutubeId(url)\n                });\n        });\n        $(ModalVideo.SELECTORS.VIDEOS_FIELD).val(JSON.stringify(videos));\n        ModalVideo.printVideos(videos);\n        $(ModalVideo.SELECTORS.CANCEL_BUTTON).trigger('click');\n    };\n\n    static resetModal = () => {\n        ModalVideo.clearAllData();\n        ModalVideo.printTocs();\n    };\n\n    static clearAllData = () => {\n        $(ModalVideo.SELECTORS.VIDEOS_FIELD).val('[]');\n        $(ModalVideo.SELECTORS.PREVIEW_CONTAINER).html('');\n    };\n}"],"names":["ModalVideo","Modal","configure","modalConfig","CONTENT_BLOCK","SELECTORS","registerEventListeners","modal","this","getModal","on","CustomEvents","events","activate","SUBMIT_BUTTON","updateVideoField","getRoot","CANCEL_BUTTON","e","stopPropagation","preventDefault","hide","OPEN_BUTTON","OPEN_BUTTON_CONTAINER","CLOSE_CROSS","ROOT_MODAL","DATA_TOC","BOOK_ID_SELECTOR","SEARCH_CLASS","VIDEOS_FIELD","DELETE_SELECTED","PREVIEW_CLASS","PREVIEW_TEXT","PREVIEW_CONTAINER","TRIGGER_PLAYER","PLAY_BUTTON_HOVER","bookId","val","tocArgs","id","page","getAjaxCall","tocs","videosArgs","videos","innerTocHtml","issetTocVideo","BreakException","forEach","value","index","uniqueIndex","videosList","currentPage","video","getYoutubePreview","getYoutubeId","undefined","closest","addClass","strings","removeClass","html","linkId","target","attr","currentTarget","siblings","trigger","issetVideos","getIssetVideos","printVideos","preCheckVideos","methodname","args","callback","ajax","call","then","response","JSON","parse","fail","window","console","log","previewBlock","deleteSelectedEvent","link","urlParams","split","URLSearchParams","get","message","find","each","videoItem","videoUnique","remove","url","push","name","text","unique","video_id","stringify","clearAllData","printTocs"],"mappings":"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"}