{"version":3,"file":"modal_video.min.js","sources":["../src/modal_video.js"],"sourcesContent":["define([\n    \"exports\",\n    \"jquery\",\n    \"core/ajax\",\n    \"core/modal_factory\",\n    \"core/modal_events\",\n    \"core/notification\",\n    \"core/modal\",\n    \"core/custom_interaction_events\",\n    \"core/modal_registry\",\n    \"mod_lanebs/modal_player_handle\",\n    \"core/str\",\n], function (\n    exports,\n    $,\n    ajax,\n    ModalFactory,\n    ModalEvents,\n    Notification,\n    Modal,\n    CustomEvents,\n    ModalRegistry,\n    ModalPlayerHandle,\n    Str,\n) {\n    let SELECTORS = {\n        SUBMIT_BUTTON: \"[data-action='submit_button']\",\n        OPEN_BUTTON: \"#id_modal_video_button\",\n        OPEN_BUTTON_CONTAINER: \"#id_modal_video_button\",\n        CANCEL_BUTTON: \"[data-action='close_button']\",\n        CONTENT_BLOCK: \"[data-action='video_content_block']\",\n        CLOSE_CROSS: \".close\",\n        ROOT_MODAL: \"[data-region='modal-container']\",\n        DATA_TOC: \"#data-toc\",\n        BOOK_ID_SELECTOR: \"[name='content']\",\n        SEARCH_CLASS: \".modal_video\",\n        VIDEOS_FIELD: \"input[name='videos']\",\n        DELETE_SELECTED: \"span.closes\",\n        PREVIEW_CLASS: \".video-item\",\n        PREVIEW_TEXT: \"span.video_preview\",\n        PREVIEW_CONTAINER: \".video_preview_container\",\n        TRIGGER_PLAYER: \"img.modal_video\",\n        PLAY_BUTTON_HOVER: \".video_play_hover\",\n    };\n\n    /**\n     * Constructor for the Modal\n     *\n     */\n    let ModalVideo = function(root) {\n        Modal.call(this, root);\n        ModalVideo.prototype.modal = this;\n        this.printTocs();\n    };\n\n    ModalVideo.TYPE = 'mod_lanebs-video';\n    ModalVideo.CONTENT_BLOCK = SELECTORS.CONTENT_BLOCK;\n    ModalVideo.prototype = Object.create(Modal.prototype);\n    ModalVideo.prototype.constructor = ModalVideo;\n\n    ModalVideo.prototype.registerEventListeners = function () {\n        Modal.prototype.registerEventListeners.call(this);\n\n        this.getModal().on(CustomEvents.events.activate, SELECTORS.SUBMIT_BUTTON, ModalVideo.prototype.updateVideoField);\n\n        this.getRoot().on(CustomEvents.events.activate, SELECTORS.CANCEL_BUTTON+', '+SELECTORS.CLOSE_CROSS, function () {\n            this.destroy();\n            this.getBackdrop().then(function (backdrop) {\n                backdrop.hide();\n            });\n        }.bind(this));\n/*        this.getModal().on(CustomEvents.events.activate, SELECTORS.CANCEL_BUTTON, function () {\n            $(this).trigger('hide');\n        }.bind(this));*/\n    };\n\n    ModalVideo.prototype.printTocs = function () {\n        let bookId = $(SELECTORS.BOOK_ID_SELECTOR).val();\n        if (bookId !== '') {\n            let tocArgs = {\n                id: bookId,\n                page: 0\n            };\n            ModalVideo.prototype.getAjaxCall('mod_lanebs_toc_name', tocArgs, function (tocs) {\n                let videosArgs = {\n                    id: $(SELECTORS.BOOK_ID_SELECTOR).val()\n                };\n                ModalVideo.prototype.getAjaxCall('mod_lanebs_toc_videos', videosArgs, function (videos) {\n                    let body = ModalVideo.prototype.modal.getBody();\n                    let innerTocHtml = '';\n                    let issetTocVideo = [];\n                    let BreakException = {};\n                    if (tocs) {\n                        tocs.forEach(function (value, index) {\n                            let videosList = '<ul class=\"modal_video\">';\n                            let currentPage = value['page'];\n                            issetTocVideo[index] = false;\n                            let uniqueIndex;\n                            try {\n                                videos.forEach(function (video, videoIndex) {\n                                    if (video['start_page'] === currentPage) {\n                                        issetTocVideo[index] = true;\n                                        uniqueIndex = video['unique_id'] + '_' + index;\n                                        videosList +=\n                                            '<li class=\"modal_video\">' +\n                                            '<label for=\"video_' + uniqueIndex + '\" class=\"modal_video\">' +\n                                            '<p class=\"modal_video\">' +\n                                            '<input type=\"checkbox\" data-unique=\"' + uniqueIndex + '\" class=\"modal_video\" id=\"video_' + uniqueIndex + '\" data-url=\"' + video['link_url'] + '\" />' +\n                                            video['link_name'] +\n                                            '</p>' +\n                                            '<img src=\"' + ModalVideo.prototype.getYoutubePreview(video['link_url']) + '\" alt=\"' + video['link_name'] + '\" class=\"modal_video\" data-id=\"' + ModalVideo.prototype.getYoutubeId(video['link_url']) + '\" />' +\n                                            '<div class=\"video_play_hover\"></div>' +\n                                            '</label>' +\n                                            '</li>';\n                                    } else if (video['start_page'] === '-1') {\n                                        issetTocVideo[index] = undefined;\n                                        $(SELECTORS.OPEN_BUTTON_CONTAINER).closest('.form-group').addClass('hidden');\n                                        throw BreakException;\n                                    }\n                                });\n                            } catch (e) {\n                                if (e !== BreakException) throw e;\n                            }\n                            videosList += '</ul>';\n                            if (issetTocVideo[index] === true) {\n                                innerTocHtml +=\n                                    '<div class=\"item-toc\" style=\"margin-bottom:10px;\" data-page=\"' + currentPage + '\">' +\n                                    '<span>' + value['title'] + ', ' + ModalVideo.prototype.strings['lanebs_read_pg'] + '. ' + value['page'] + '</span><br>' +\n                                    '<a class=\"\" data-toggle=\"collapse\" href=\"#collapseDescription_' + currentPage + '_' + index + '\" role=\"button\">' +\n                                    'Видео-рекомендации' +\n                                    '</a>' +\n                                    '<div class=\"collapse\" id=\"collapseDescription_' + currentPage + '_' + index + '\">' + videosList + '</div>' +\n                                    '</div>';\n                            }\n                        });\n                    }\n                    if (issetTocVideo[0] !== undefined) {\n                        $(SELECTORS.OPEN_BUTTON_CONTAINER).closest('.form-group').removeClass('hidden');\n                        body.find(SELECTORS.DATA_TOC).html(innerTocHtml);\n                        $(body.find(SELECTORS.TRIGGER_PLAYER)).on('click', function (e) {\n                            let linkId = $(e.target).attr('data-id');\n                            ModalPlayerHandle.init(e, linkId);\n                        });\n                        $(body.find(SELECTORS.PLAY_BUTTON_HOVER)).on('click', function (e) {\n                            e.preventDefault();\n                            e.stopPropagation();\n                            $(e.currentTarget).siblings(SELECTORS.TRIGGER_PLAYER).trigger('click');\n                        });\n                    }\n                    let issetVideos = ModalVideo.prototype.getIssetVideos();\n                    if (issetVideos) {\n                        ModalVideo.prototype.printVideos(issetVideos);\n                        ModalVideo.prototype.preCheckVideos(issetVideos);\n                    }\n                });\n            });\n        }\n    };\n\n    ModalVideo.prototype.getAjaxCall = function (methodname, args, callback) {\n        return ajax.call([\n            {\n                methodname: methodname,\n                args,\n            }\n        ])[0].then(function(response) {\n            return response;\n        }).done(function(response) {\n            callback(JSON.parse(response['body']));\n            return true;\n        }).fail(function (response) {\n            console.log(response);\n            return false;\n        });\n    };\n\n    ModalVideo.prototype.printVideos = function (videos) {\n        let previewBlock = '<div class=\"col-md-3\"></div><div class=\"container col-md-9\">';\n        videos.forEach(function (value, index) {\n            previewBlock +=\n                '<div class=\"item video-item row\">' +\n                '<div class=\"img-wraps\">' +\n                '<span class=\"closes\" title=\"Delete\" data-unique=\"'+value['unique']+'\">×</span>' +\n                '<img width=\"100px;\" height=\"100px;\" src=\"'+ModalVideo.prototype.getYoutubePreview(value['link'])+'\" alt=\"'+value['name']+'\"  class=\"img-responsive\" src=\"images/image.jpg\" data-id=\"'+ModalVideo.prototype.getYoutubeId(value['link'])+'\"/>' +\n                '</div>' +\n                '<span class=\"video_preview\">'+value['name']+'</span>' +\n                '</div>';\n        });\n        previewBlock += '</div>';\n        $(SELECTORS.PREVIEW_CONTAINER).html(previewBlock);\n        ModalVideo.prototype.deleteSelectedEvent();\n    };\n\n    ModalVideo.prototype.getYoutubeId = function (link) {\n        let urlParams = link.split('?')[1];\n        return (new URLSearchParams(urlParams)).get('v');\n    };\n\n    ModalVideo.prototype.getYoutubePreview = function (link) {\n        let id = ModalVideo.prototype.getYoutubeId(link);\n        return 'https://img.youtube.com/vi/'+id+'/0.jpg';\n    };\n\n    ModalVideo.prototype.getIssetVideos = function () {\n        let videos = $(SELECTORS.VIDEOS_FIELD).val();\n        try {\n            return JSON.parse(videos);\n        } catch (e) {\n            console.log(e.message);\n            return '';\n        }\n    };\n\n    ModalVideo.prototype.preCheckVideos = function (videos) {\n        videos.forEach(function (value, index) {\n            ModalVideo.prototype.modal.getBody().find('input[data-unique=\"'+value['unique']+'\"]').trigger('click');\n        });\n    };\n\n    ModalVideo.prototype.deleteSelectedEvent = function () {\n        $(SELECTORS.DELETE_SELECTED).each(function (index, value) {\n            $(value).on('click', function (e) {\n                let videoItem = $(e.target).closest(SELECTORS.PREVIEW_CLASS);\n                let videoUnique = $(e.target).attr('data-unique');\n                ModalVideo.prototype.modal.getBody().find('input[data-unique=\"'+videoUnique+'\"]').trigger('click');\n                $(videoItem).remove();\n                ModalVideo.prototype.updateVideoField();\n            });\n        });\n    };\n\n    ModalVideo.prototype.updateVideoField = function () {\n        let videos = [];\n        let inputs = ModalVideo.prototype.modal.getBody().find('ul'+SELECTORS.SEARCH_CLASS+' input:checked');\n        inputs.each(function (index, value) {\n            let url = $(value).attr('data-url');\n            videos.push(\n                {\n                    link: url,\n                    name: $(value).closest('p').text(),\n                    unique: $(value).attr('data-unique'),\n                    video_id: ModalVideo.prototype.getYoutubeId(url)\n                });\n        });\n        $(SELECTORS.VIDEOS_FIELD).val(JSON.stringify(videos));\n        ModalVideo.prototype.printVideos(videos);\n        $(SELECTORS.CANCEL_BUTTON).trigger('click');\n    }\n\n    ModalVideo.prototype.clearAllData = function () {\n        $(SELECTORS.VIDEOS_FIELD).val('[]');\n        $(SELECTORS.PREVIEW_CONTAINER).html('');\n    };\n\n    ModalVideo.prototype.resetModal = function () {\n        ModalVideo.prototype.clearAllData();\n        ModalVideo.prototype.printTocs();\n    }\n\n\n    ModalRegistry.register(ModalVideo.TYPE, ModalVideo, 'mod_lanebs/modal_video');\n\n    return ModalVideo;\n});"],"names":["define","exports","$","ajax","ModalFactory","ModalEvents","Notification","Modal","CustomEvents","ModalRegistry","ModalPlayerHandle","Str","SELECTORS","ModalVideo","root","call","this","prototype","modal","printTocs","TYPE","CONTENT_BLOCK","Object","create","constructor","registerEventListeners","getModal","on","events","activate","updateVideoField","getRoot","destroy","getBackdrop","then","backdrop","hide","bind","bookId","val","tocArgs","id","page","getAjaxCall","tocs","videosArgs","videos","body","getBody","innerTocHtml","issetTocVideo","BreakException","forEach","value","index","uniqueIndex","videosList","currentPage","video","videoIndex","getYoutubePreview","getYoutubeId","undefined","closest","addClass","e","strings","removeClass","find","html","linkId","target","attr","init","preventDefault","stopPropagation","currentTarget","siblings","trigger","issetVideos","getIssetVideos","printVideos","preCheckVideos","methodname","args","callback","response","done","JSON","parse","fail","console","log","previewBlock","deleteSelectedEvent","link","urlParams","split","URLSearchParams","get","message","each","videoItem","videoUnique","remove","url","push","name","text","unique","video_id","stringify","clearAllData","resetModal","register"],"mappings":"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"}